#!/bin/sh

schemaspath="/usr/share/glib-2.0/schemas/"
profileuser="/etc/dconf/profile/user"
settings="/etc/dconf/db/local.d/settings"
settingslocks="/etc/dconf/db/local.d/locks/settings"

processfile # ($1) takes 1 parameter [ name of the file ]
{
	# split name to dirs
	path=""
	dirs=$(echo $1 | tr "." "\n")
	for dir in $dirs
	do
	    path="$path$dir/"
	done

	# prepare settings file [ %? deletes last symbol "/"]
	echo "[${path%?}]" >> settings
    
	while read -r line
    do
		# search content in strings like name="..."
       	readline=$(sed -n '/^name/{ s/[^"]*"\([^"]*\)".*/\1/; p }' <<< $line)
       	echo -n $readline >> settings
        if [ "$readline" != "" ]
        then 
            echo "/$path$readline" >> settingslocks
        fi
		# search content in strings like <default>...</default>
        sed -n '/^<default/{ s/[^"]*>\([^<]*\)<.*/=\1/; p }' <<< $line >> settings
    done < "$schemaspath$1.gschema.xml"
}
# end processfile --- --- --- --- ---

lock # ($1) takes 1 parameter [ type of lock: all, interactive ]
{
	mkdir -p /etc/dconf/db/local.d/locks
	echo -e "user-db:user\nsystem-db:local" > $profileuser
    echo -n "" > settings
    echo -n "" > settingslocks

	if [ $1 == "all" ]
	then
		for file in $(gsettings list-schemas) 
		do
   			processfile $file 
		done
	elif [ $1 == "interactive"] 
		
	fi
    
    dconf update
    echo "Dconf locked successfully!"
    exit 0
}
# end lock --- --- --- --- ---
